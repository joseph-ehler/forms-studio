name: Design System Contracts

on:
  pull_request:
    paths:
      - 'packages/wizard-react/src/tokens/**'
      - 'packages/wizard-react/src/components/**'
      - 'contracts/**'

jobs:
  token-diff:
    name: Token Snapshot Diff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check token snapshot changes
        id: token-check
        run: |
          if git diff origin/main --name-only | grep -q "contracts/tokens@"; then
            echo "tokens_changed=true" >> $GITHUB_OUTPUT
            echo "⚠️ Token snapshot changed" >> $GITHUB_STEP_SUMMARY
          else
            echo "tokens_changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Require tokens-change label
        if: steps.token-check.outputs.tokens_changed == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            if (!labels.includes('tokens-change')) {
              core.setFailed('Token snapshot changed but PR is missing "tokens-change" label');
            }
      
      - name: Generate token diff
        if: steps.token-check.outputs.tokens_changed == 'true'
        run: |
          echo "## Token Changes" >> $GITHUB_STEP_SUMMARY
          git diff origin/main contracts/tokens@*.json >> $GITHUB_STEP_SUMMARY

  visual-regression:
    name: Visual Screenshots
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps
      
      - name: Run visual contract tests
        run: npx playwright test tests/contracts/visual/
      
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: screenshots
          path: test-results/
          retention-days: 30
      
      - name: Check pixel diff
        run: |
          # Fail if >1% pixel diff
          echo "Visual regression threshold: 1%" >> $GITHUB_STEP_SUMMARY

  accessibility:
    name: A11y Contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps
      
      - name: Run accessibility tests
        run: npx playwright test tests/contracts/accessibility/
      
      - name: Generate a11y report
        if: always()
        run: |
          echo "## Accessibility Report" >> $GITHUB_STEP_SUMMARY
          echo "All interactive elements must meet WCAG 2.1 AA (4.5:1)" >> $GITHUB_STEP_SUMMARY

  behavioral:
    name: Behavioral Contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps
      
      - name: Run behavioral tests
        run: npx playwright test tests/contracts/behavioral/
      
      - name: Run keyboard navigation tests
        run: npx playwright test tests/contracts/keyboard/

  summary:
    name: Contract Summary
    needs: [token-diff, visual-regression, accessibility, behavioral]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "# Design System Contract Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All contracts passed" >> $GITHUB_STEP_SUMMARY
