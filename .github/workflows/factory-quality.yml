name: Factory Quality Gates

on:
  pull_request:
    paths:
      - 'packages/forms/src/fields/**'
      - 'scripts/generator/**'
      - 'scripts/refiner/**'
      - 'specs/fields/**'

jobs:
  factory-checks:
    name: Generator + Refiner + Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: 🧪 Generator Self-Test
        run: pnpm generator:test
      
      - name: 🔍 Refiner Dry-Run (enforce standards)
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 REFINER DRY-RUN: Checking for pattern violations"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          pnpm refine:dry --scope="packages/forms/src/fields/**/*.tsx"
          
          # Fail if Refiner reports any violations
          if [ $? -ne 0 ]; then
            echo "❌ Refiner found violations. Run 'pnpm refine:run' locally to fix."
            exit 1
          fi
          
          echo "✅ No pattern violations detected!"
      
      - name: 🏗️ Build All Packages
        run: pnpm -w build
      
      - name: 🔬 Compliance Guard (batch analysis)
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🔬 BATCH ANALYSIS: Verifying compliance baseline"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          pnpm analyze:batch "packages/forms/src/fields/**/*.tsx" 2>/dev/null > tmp/compliance-report.json
          
          # Assert baseline metrics (prevent regression)
          FULL_COMPLIANCE=$(jq '.aggregate.compliance.fullCompliance' tmp/compliance-report.json)
          NO_INLINE_STYLES=$(jq '.aggregate.compliance.noInlineStyles' tmp/compliance-report.json)
          RHF_INTEGRATION=$(jq '.aggregate.compliance.rhfIntegration' tmp/compliance-report.json)
          
          echo "Full Compliance: $FULL_COMPLIANCE/23"
          echo "No Inline Styles: $NO_INLINE_STYLES/23"
          echo "RHF Integration: $RHF_INTEGRATION/23"
          
          if [ "$FULL_COMPLIANCE" -lt 23 ]; then
            echo "❌ Compliance regression detected! Expected 23, got $FULL_COMPLIANCE"
            exit 1
          fi
          
          if [ "$NO_INLINE_STYLES" -lt 23 ]; then
            echo "❌ Inline styles detected! Expected 0, found violations"
            exit 1
          fi
          
          if [ "$RHF_INTEGRATION" -lt 23 ]; then
            echo "❌ RHF integration regression! Expected 23, got $RHF_INTEGRATION"
            exit 1
          fi
          
          echo "✅ All compliance metrics meet baseline!"
      
      - name: 📊 Report Status
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 FACTORY QUALITY GATE RESULTS"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Generator Test: ${{ steps.generator.outcome }}"
          echo "Refiner Check: ${{ steps.refiner.outcome }}"
          echo "Build: ${{ steps.build.outcome }}"
          echo ""
          echo "All checks must pass before merge."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
