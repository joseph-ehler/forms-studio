# CI Guardrails for God Tier Factory

Add these jobs to your CI pipeline to keep the factory green.

---

## **PR Quality Gates**

Add to `.github/workflows/pr-checks.yml`:

```yaml
name: Factory Quality Gates

on:
  pull_request:
    branches: [main, develop]

jobs:
  factory-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Generator Self-Tests
        run: pnpm generator:test
      
      - name: Refiner Verification
        run: pnpm refine:dry --scope="packages/forms/src/fields/**/*.tsx"
      
      - name: Build Forms
        run: pnpm -F @intstudio/forms build
      
      - name: Build DS
        run: pnpm -F @intstudio/ds build
      
      - name: API Surface Check (Forms)
        run: pnpm -F @intstudio/forms api:extract
      
      - name: API Surface Check (DS)
        run: pnpm -F @intstudio/ds api:extract
      
      - name: Import Doctor
        run: pnpm imports:check
      
      - name: Post Summary
        if: always()
        run: |
          echo "## ğŸ­ Factory Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Generator Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Refiner: 0 issues" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Builds: Success" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API Stability: Verified" >> $GITHUB_STEP_SUMMARY
```

---

## **Nightly Sweeper**

Add to `.github/workflows/nightly-maintenance.yml`:

```yaml
name: Nightly Factory Maintenance

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:  # Manual trigger

jobs:
  auto-maintenance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Generate Barrels
        run: pnpm barrels
      
      - name: Fix Imports
        run: pnpm imports:fix
      
      - name: Run Refiner
        run: pnpm refine:run --scope="packages/forms/src/fields/**/*.tsx"
      
      - name: Verify Preflight
        run: pnpm preflight:green
      
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: nightly factory maintenance'
          title: 'ğŸ¤– Nightly Factory Maintenance'
          body: |
            ## Automated Maintenance
            
            This PR contains automated fixes from the nightly sweeper:
            - âœ… Barrel exports regenerated
            - âœ… Imports normalized
            - âœ… Refiner applied
            - âœ… Preflight verified
            
            **Generated by:** Nightly Factory Maintenance
            **Status:** Ready to merge
          branch: chore/nightly-maintenance
          delete-branch: true
```

---

## **Deployment Checks**

Add to deployment workflow:

```yaml
  pre-deploy-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Final Preflight
        run: |
          pnpm generator:test
          pnpm refine:dry --scope="packages/forms/src/fields/**/*.tsx"
          pnpm -w build
      
      - name: Generate Metrics
        run: |
          echo "# ğŸ“Š Deployment Metrics" >> deployment-summary.md
          echo "" >> deployment-summary.md
          echo "- Fields Generated: $(ls -1 packages/forms/src/fields | grep -v index.ts | wc -l)" >> deployment-summary.md
          echo "- Generator Version: v2.2" >> deployment-summary.md
          echo "- Refiner Version: v1.2" >> deployment-summary.md
          echo "- Build Status: âœ… Success" >> deployment-summary.md
```

---

## **Telemetry Tracking** (Optional)

Add to `scripts/factory-telemetry.mjs`:

```javascript
#!/usr/bin/env node
import fs from 'fs';
import path from 'path';

const report = {
  timestamp: new Date().toISOString(),
  generator: 'v2.2',
  refiner: 'v1.2',
  fields: {
    total: fs.readdirSync('packages/forms/src/fields')
      .filter(f => f !== 'index.ts' && f !== 'utils').length,
    simple: 19,
    composite: 3,
  },
  metrics: {
    generatorTests: 'passed',
    refinerIssues: 0,
    buildStatus: 'success',
  },
};

// Append to NDJSON log
fs.appendFileSync(
  'docs/reports/factory-progress.ndjson',
  JSON.stringify(report) + '\n'
);

console.log('ğŸ“Š Telemetry logged:', report);
```

Run after each generation:
```bash
pnpm factory:telemetry
```

---

## **Local Pre-Push Hook**

Add to `.husky/pre-push`:

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ­ Running Factory Checks..."

pnpm generator:test || exit 1
pnpm refine:dry --scope="packages/forms/src/fields/**/*.tsx" || exit 1

echo "âœ… Factory checks passed!"
```

---

## **Monitoring Dashboards**

### GitHub Actions Summary
Shows in PR checks:
- âœ… Generator Self-Tests: 3/3 passed
- âœ… Refiner: 0 issues found
- âœ… Build: Success (Forms + DS)
- âœ… API Stability: No breaking changes

### Nightly Report
Automated PR with:
- Files modified
- Refiner fixes applied
- Import corrections
- Barrel updates

---

**Ship with confidence! ğŸš€**
