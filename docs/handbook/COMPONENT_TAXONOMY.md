# Component Taxonomy (Class-Based Factory)

**Status**: ‚úÖ **LOCKED & ENFORCED**  
**Version**: 1.0.0

---

## **The Problem We Solved**

**Symptom**: Components looked right but didn't work
- Checkboxes that don't toggle
- Radios that don't group
- Sheets used where modals were intended

**Root Cause**: Name-based stamping
- Generated by name (Checkbox, Sheet) without understanding behavioral class
- Applied one template to all components
- Skipped research on actual API contracts

**Cost**: 30+ minutes fixing each component after generation

---

## **The Solution: Class ‚Üí Engine ‚Üí Adapter ‚Üí Wrapper**

Every component belongs to a **behavioral class**. The factory must classify first, then stamp.

---

## **The 7 Component Classes**

### **1. Input** (Controlled form elements)

**Behavior:**
- Controlled (require `value`/`checked` + `onChange`)
- No children (self-closing)
- Needs label wrapper
- Participates in forms (RHF integration)

**Examples**: Checkbox, Radio, Toggle, TextInput, Textarea, Select

**Engine**: Flowbite (preferred)

**Template**: `input-controlled`

**Rules:**
- ‚ùå No children prop
- ‚úÖ Must have controlled props
- ‚úÖ Stories show controlled usage
- ‚úÖ Radio requires `name` for grouping

---

### **2. Container** (Passive display)

**Behavior:**
- Accepts children
- No internal state
- Display-only

**Examples**: Badge, Chip, Label, Card

**Engine**: Flowbite

**Template**: `container-passthrough`

**Rules:**
- ‚úÖ Accepts children
- ‚úÖ Passive (no onChange)

---

### **3. Dialog** (Modal overlays)

**Behavior:**
- Desktop-centric
- Focus trap
- ESC to close
- Backdrop + body scroll lock
- Returns focus to trigger

**Examples**: Modal, AlertDialog, ConfirmDialog

**Engine**: Flowbite Modal

**Template**: `dialog-modal`

**Rules:**
- ‚úÖ `aria-label` or `aria-labelledby`
- ‚úÖ Focus trap on open
- ‚úÖ ESC closes
- ‚úÖ Body scroll locked

---

### **4. Sheet** (Gesture overlays)

**Behavior:**
- Mobile-first
- Gesture-driven (drag to dismiss)
- Bottom-anchored (or side)
- Haptics on dismiss
- Can show over keyboard

**Examples**: BottomSheet, Drawer (mobile)

**Engine**: FlowbiteDrawer (base) + react-spring-bottom-sheet (gestures)

**Template**: `sheet-drawer`

**Rules:**
- ‚úÖ `aria-label` or `aria-labelledby`
- ‚úÖ Drag-to-dismiss (mobile only)
- ‚úÖ `onBeforeDismiss` respected
- ‚úÖ Gesture enhancement opt-in (`enableGestures`)

---

### **5. Positioned** (Anchored floating)

**Behavior:**
- Anchored to trigger
- Collision-aware (flips/shifts)
- Virtual element support
- Stays in viewport

**Examples**: Popover, Tooltip, Menu, Dropdown

**Engine**: @floating-ui/react

**Template**: `positioned-floating`

**Rules:**
- ‚úÖ Anchor required
- ‚úÖ Collision detection
- ‚úÖ Portal rendering
- ‚úÖ Focus management

---

### **6. Virtualized** (Large lists)

**Behavior:**
- Windowing (render visible only)
- Smooth scroll
- Dynamic item heights
- Infinite scroll support

**Examples**: VirtualList, VirtualTable

**Engine**: react-virtuoso

**Template**: `virtualized-list`

**Rules:**
- ‚úÖ Data-driven
- ‚úÖ Item renderer
- ‚úÖ Windowing enabled

---

### **7. CompositeWidget** (Stateful patterns)

**Behavior:**
- Complex internal state
- Multiple interaction patterns
- Keyboard navigation
- Accessibility contracts (ARIA)

**Examples**: Combobox, DatePicker, ColorPicker, RichSelect

**Engine**: React Aria / Downshift / Radix (choose one per widget type)

**Template**: `composite-custom`

**Rules:**
- ‚úÖ Requires ADR before implementation
- ‚úÖ Headless engine chosen
- ‚úÖ RHF integration built-in
- ‚úÖ Mobile adaptation (Sheet vs Popover)
- ‚úÖ Full canary coverage

---

## **The Decision Ladder (Flowbite-First)**

**Before stamping ANY component, run this ladder:**

### **Step 1: Does Flowbite have this component?**

```bash
pnpm ds:research <ComponentName>
```

**Yes?** ‚Üí Wrap it (preferred path)
- Import from `flowbite-react`
- Apply SKIN tokens
- Pass through props
- Add capability awareness (if needed)

**Examples**: Checkbox, Modal, Textarea, Badge, Tooltip

**No?** ‚Üí Go to Step 2

---

### **Step 2: Can we model it using Flowbite parts?**

**Compose from existing Flowbite components:**
- Sheet = Flowbite Drawer (bottom-anchored) + CSS + optional gestures
- Responsive Overlay = Modal (desktop) + Drawer (mobile)
- Custom Card = Flowbite Card + custom layout

**Yes?** ‚Üí Build the pattern (no new engines)

**No?** ‚Üí Go to Step 3

---

### **Step 3: Is a headless engine justified?**

**Only if Flowbite can't provide the behavior:**
- Collision-aware positioning ‚Üí Floating UI
- Gesture physics ‚Üí use-gesture + react-spring
- Virtualization ‚Üí Virtuoso
- Complex widgets ‚Üí React Aria/Downshift

**Yes?** ‚Üí Use engine behind an adapter
- Define adapter interface
- Hide vendor behind it
- Add capability checks
- Write canaries

**No?** ‚Üí Write ADR and defer
- Document why we don't have it yet
- Propose alternatives
- Don't stamp until decided

---

## **Enforced Workflow**

### **Before Generation (Hard Gate)**

```bash
# 1. Research (mandatory)
pnpm ds:research <ComponentName>

# 2. Classify (add to classmap)
# Edit: packages/ds/src/control/components.classmap.json
{
  "ComponentName": {
    "class": "Input",          // Choose class
    "engine": "Flowbite",      // Choose engine
    "flowbiteName": "Checkbox", // Flowbite export name
    "controlledProps": ["checked", "onChange"],
    "acceptsChildren": false,
    "notes": "Self-closing input element"
  }
}

# 3. Generate (with class context)
pnpm ds:new <ComponentName>
```

**Generator will:**
- ‚úÖ Read classmap for component
- ‚úÖ Use class-specific template
- ‚úÖ Import correct Flowbite component
- ‚úÖ Apply class-specific rules
- ‚úÖ Generate correct stories

**Generator will FAIL if:**
- ‚ùå No research snapshot
- ‚ùå Not in classmap
- ‚ùå Invalid class
- ‚ùå Missing engine

---

### **After Generation (Validation)**

```bash
# Validate
pnpm typecheck  # TypeScript compiles
pnpm lint       # ESLint passes (no-children-on-inputs, etc.)
pnpm doctor     # All gates pass
pnpm sb         # Manual: View in Storybook
```

**Check:**
- [ ] Component renders correctly
- [ ] Stories demonstrate correct usage
- [ ] Controlled inputs have state
- [ ] Labels wrap inputs correctly
- [ ] Radio groups use `name`
- [ ] ESC closes dialogs
- [ ] Canaries pass

---

## **Class-Specific Rules**

### **Input Rules**

```typescript
// ‚ùå WRONG
<Checkbox variant="default">Label text</Checkbox>

// ‚úÖ CORRECT
<label>
  <Checkbox variant="default" checked={checked} onChange={setChecked} />
  <span>Label text</span>
</label>
```

**ESLint Rule**: `no-children-on-inputs`

---

### **Dialog Rules**

```typescript
// ‚úÖ REQUIRED
<Modal 
  show={open} 
  onClose={() => setOpen(false)}
  aria-label="Confirm action"  // Required!
>
  <Modal.Header>Title</Modal.Header>
  <Modal.Body>Content</Modal.Body>
</Modal>
```

**Canary**: ESC closes, focus returns to trigger

---

### **Sheet Rules**

```typescript
// ‚úÖ Base (Flowbite Drawer)
<Sheet isOpen={open} onClose={() => setOpen(false)} position="bottom">
  Content
</Sheet>

// ‚úÖ Enhanced (with gestures)
<Sheet 
  isOpen={open} 
  onClose={() => setOpen(false)} 
  enableGestures  // Opt-in
  onBeforeDismiss={async () => {
    const confirmed = await askUser();
    return confirmed;
  }}
>
  Content
</Sheet>
```

**Canary**: Drag to dismiss (mobile), `onBeforeDismiss` fires

---

## **What This Unlocks**

### **Clarity**

Developers know what they're getting:
- `<Modal>` = Desktop dialog (focus trap, ESC)
- `<Sheet>` = Mobile sheet (gestures, bottom)
- `<Checkbox>` = Controlled input (needs `checked` + `onChange`)

No surprises, no "looks right but doesn't work."

---

### **Correctness**

Generator produces correct code first time:
- Inputs are controlled by default
- Dialogs have focus traps
- Sheets have gestures (opt-in)
- Stories show correct usage

---

### **Safety**

Hard gates prevent mistakes:
- ESLint forbids children on inputs
- Generator requires classmap entry
- Research snapshot mandatory
- Class canaries must pass

---

### **Speed**

80% of components (Inputs, Containers, Dialogs) stamp in **2 minutes**.

20% of components (Positioned, CompositeWidget) take **hours to days**, but that's intentional (requires adapter + ADR).

---

## **The Classmap (Central Registry)**

üìÑ `packages/ds/src/control/components.classmap.json`

**Format:**
```json
{
  "ComponentName": {
    "class": "Input | Container | Dialog | Sheet | Positioned | Virtualized | CompositeWidget",
    "engine": "Flowbite | @floating-ui/react | react-virtuoso | etc.",
    "flowbiteName": "Checkbox | null",
    "controlledProps": ["checked", "onChange"],
    "requiresProps": ["name"],
    "acceptsChildren": true | false,
    "enhancement": "optional-engine-name",
    "notes": "Behavioral notes"
  }
}
```

**Rules:**
- All generated components must have entry
- Entry created during research step
- Generator reads classmap before stamping
- API Extractor validates public API stability

---

## **Success Metrics**

**Before Taxonomy:**
- 0/5 components worked first time
- 30+ min fixing each component
- Storybook broken repeatedly

**After Taxonomy:**
- **Expected: 5/5 components work first time**
- **2-15 min per component** (depends on class)
- **Storybook works immediately**

---

## **Next: Composite Widgets (Lane C)**

**When we need Combobox, DatePicker, etc.:**

1. **Write spike ADR** (1-2 days max)
   - Evaluate engines (React Aria, Downshift, Radix)
   - Test with RHF
   - Test mobile adaptation (Sheet picker)
   - Choose one

2. **Define adapter interface**
   ```typescript
   interface ComboboxAdapter {
     getInputProps(): any;
     getListProps(): any;
     getItemProps(index: number): any;
     open: boolean;
     selectedItem: any;
   }
   ```

3. **Wrap behind DS API**
   - SKIN tokens
   - RHF integration
   - Mobile Sheet picker (opt-in)
   - Keyboard navigation

4. **Ship with canaries**
   - Keyboard typing filters
   - Arrow navigation
   - Selection updates
   - Mobile sheet works
   - RHF integration

---

## **Documentation**

- **This doc**: Component taxonomy and classification
- **Workflow**: `DS_GENERATION_WORKFLOW.md` - Step-by-step process
- **Protocol**: `FLOWBITE_RESEARCH_PROTOCOL.md` - Research checklist
- **Classmap**: `packages/ds/src/control/components.classmap.json` - Registry

---

## **TL;DR**

1. **Classify first** (Input, Dialog, Sheet, etc.)
2. **Flowbite first** (prefer wrapping over building)
3. **Research mandatory** (know the API before stamping)
4. **Class-specific templates** (inputs are controlled, dialogs have focus traps)
5. **Hard gates** (ESLint, canaries, classmap entry required)

**Result**: Stamp with context. Ship with confidence. No surprises.
